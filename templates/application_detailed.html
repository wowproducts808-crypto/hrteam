{% extends "base.html" %}
{% block content %}

<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏) —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é -->
<div style="margin-bottom: 20px; text-align: left; display: block; width: 100%;">
  <nav style="font-size: 14px; color: #6c757d; display: inline-block;">
    <a href="/" style="color: #3498db; text-decoration: none;">–ì–ª–∞–≤–Ω–∞—è</a>
    <span style="margin: 0 8px;">/</span>
    <a href="/my/applications" style="color: #3498db; text-decoration: none;">–ú–æ–∏ –∑–∞—è–≤–∫–∏</a>
    <span style="margin: 0 8px;">/</span>
    {% if application %}
      <span>{{ application.job.title }}</span>
    {% else %}
      <span>–°–æ–æ–±—â–µ–Ω–∏—è</span>
    {% endif %}
  </nav>
</div>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div style="margin-bottom: 30px; text-align: left;">
  <h1 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0 0 8px 0;">
    {% if application %}
      {{ application.job.title }}
    {% else %}
      –°–æ–æ–±—â–µ–Ω–∏—è
    {% endif %}
  </h1>
  <div style="color: #6c757d; font-size: 14px;">
    {% if application %}
      –ó–∞—è–≤–∫–∞ ‚Ññ{{ application.id[:6] if application.id else 'N/A' }}
    {% else %}
      –¶–µ–Ω—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
    {% endif %}
  </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
  
  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ß–∞—Ç —Å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–º -->
  <div>
    
    <!-- –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ -->
    {% if application %}
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 18px; color: #2c3e50;">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</h3>
        
        {% if application.status %}
          {% if application.status.value == 'pending' %}
            <span style="background: #fff3cd; color: #856404; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              –û–∂–∏–¥–∞–µ—Ç –≤—ã—Ö–æ–¥–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            </span>
          {% elif application.status.value == 'selected' %}
            <span style="background: #d1ecf1; color: #0c5460; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              –û—Ü–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è
            </span>
          {% elif application.status.value == 'working' %}
            <span style="background: #d4edda; color: #155724; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              –í —Ä–∞–±–æ—Ç–µ
            </span>
          {% elif application.status.value == 'completed' %}
            <span style="background: #d4edda; color: #155724; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              –ó–∞–≤–µ—Ä—à–µ–Ω–æ
            </span>
          {% elif application.status.value == 'rejected' %}
            <span style="background: #f8d7da; color: #721c24; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
            </span>
          {% else %}
            <span style="background: #f8f9fa; color: #6c757d; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              {{ application.status.value }}
            </span>
          {% endif %}
        {% endif %}
      </div>
      
      <!-- –î–µ—Ç–∞–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
        <div>
          <div style="color: #6c757d; margin-bottom: 5px;">–§–ò–û –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</div>
          <div style="color: #2c3e50; font-weight: 500;">
            {% if application.status and application.status.value in ['selected', 'working', 'completed'] %}
              {{ current_user.name if current_user else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}
            {% else %}
              –û–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
            {% endif %}
          </div>
        </div>
        <div>
          <div style="color: #6c757d; margin-bottom: 5px;">–û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</div>
          <div style="color: #2c3e50; font-weight: 500;">
            {% if application.expected_start_date %}
              {{ application.expected_start_date.strftime('%d.%m.%Y') }}
            {% else %}
              –ù–µ —É–∫–∞–∑–∞–Ω–∞
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∫—Ä—É—Ç–µ—Ä—ã -->
      <div style="margin-top: 20px;">
        <div style="color: #6c757d; margin-bottom: 10px; font-size: 14px;">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∫—Ä—É—Ç–µ—Ä—ã</div>
        {% if selected_recruiters %}
          {% for recruiter in selected_recruiters %}
            <div style="display: inline-block; background: #3498db; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin-right: 8px; margin-bottom: 8px;">
              {{ recruiter.name }}
            </div>
          {% endfor %}
        {% else %}
          <div style="color: #6c757d; font-style: italic;">–†–µ–∫—Ä—É—Ç–µ—Ä—ã –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- –ß–∞—Ç —Å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–º -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; overflow: hidden; height: 600px; display: flex; flex-direction: column;">
      
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
      <div style="background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef;">
        <div style="display: flex; align-items: center; gap: 15px;">
          <div style="width: 45px; height: 45px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <span style="color: white; font-size: 16px; font-weight: bold;">
              {% if application and application.job and application.job.employer %}
                {{ application.job.employer.name[0] }}
              {% else %}
                üë§
              {% endif %}
            </span>
          </div>
          <div>
            <h3 style="margin: 0; font-size: 18px; color: #2c3e50;">
              {% if application and application.job and application.job.employer %}
                {{ application.job.employer.name }}
              {% else %}
                –¶–µ–Ω—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
              {% endif %}
            </h3>
            <div style="color: #28a745; font-size: 14px;">‚óè –û–Ω–ª–∞–π–Ω</div>
          </div>
        </div>
      </div>
      
      <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
      <div id="chat-messages" style="flex: 1; padding: 20px; overflow-y: auto; background: #fafafa;">
        
        <!-- –†–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
        {% if chat_messages %}
          {% for message in chat_messages %}
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: {{ 'flex-end' if message.sender_id == current_user.id else 'flex-start' }}; margin-bottom: 15px;">
                <div style="max-width: 70%; 
                           background: {{ '#3498db' if message.sender_id == current_user.id else 'white' }}; 
                           color: {{ 'white' if message.sender_id == current_user.id else '#2c3e50' }}; 
                           padding: 12px 16px; 
                           border-radius: 18px; 
                           {% if message.sender_id != current_user.id %}border: 1px solid #e9ecef;{% endif %} 
                           box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                  <div style="font-size: 14px; line-height: 1.4;">
                    {{ message.content }}
                  </div>
                  <div style="font-size: 12px; 
                             color: {{ 'rgba(255,255,255,0.8)' if message.sender_id == current_user.id else '#6c757d' }}; 
                             margin-top: 8px;">
                    {{ message.created_at.strftime('%H:%M') if message.created_at else '–í—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —á–∞—Ç –ø—É—Å—Ç -->
          <div style="text-align: center; padding: 40px; color: #6c757d;">
            <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
            <div style="font-size: 16px; margin-bottom: 8px;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
            <div style="font-size: 14px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–º</div>
          </div>
        {% endif %}
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
        {% if is_typing %}
        <div style="display: flex; justify-content: flex-start; margin-bottom: 15px;">
          <div style="background: white; padding: 12px 16px; border-radius: 18px; border: 1px solid #e9ecef;">
            <div style="display: flex; align-items: center; gap: 5px; color: #6c757d; font-size: 14px;">
              <span>
                {% if application and application.job and application.job.employer %}
                  {{ application.job.employer.name }}
                {% else %}
                  –°–æ–±–µ—Å–µ–¥–Ω–∏–∫
                {% endif %}
                –ø–µ—á–∞—Ç–∞–µ—Ç
              </span>
              <div style="display: flex; gap: 2px;">
                <div style="width: 4px; height: 4px; background: #6c757d; border-radius: 50%; animation: typing 1.4s infinite ease-in-out;"></div>
                <div style="width: 4px; height: 4px; background: #6c757d; border-radius: 50%; animation: typing 1.4s infinite ease-in-out 0.2s;"></div>
                <div style="width: 4px; height: 4px; background: #6c757d; border-radius: 50%; animation: typing 1.4s infinite ease-in-out 0.4s;"></div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
        
      </div>
      
      <!-- –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
      <div style="padding: 20px; border-top: 1px solid #e9ecef; background: white;">
        <form id="message-form" onsubmit="sendMessage(event)">
          <div style="display: flex; gap: 12px; align-items: flex-end;">
            <div style="flex: 1;">
              <textarea id="message-input" 
                       name="message"
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                       style="width: 100%; min-height: 45px; max-height: 120px; padding: 12px 16px; border: 1px solid #ddd; border-radius: 24px; resize: none; outline: none; font-family: inherit; font-size: 14px; line-height: 1.4;"
                       onkeypress="handleKeyPress(event)"
                       oninput="autoResize(this)"></textarea>
            </div>
            
            <div style="display: flex; gap: 8px;">
              <button type="button" onclick="attachFile()" 
                      style="width: 45px; height: 45px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s;"
                      onmouseover="this.style.background='#e9ecef'"
                      onmouseout="this.style.background='#f8f9fa'">
                üìé
              </button>
              
              <button type="submit"
                      style="width: 45px; height: 45px; background: #3498db; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s;"
                      onmouseover="this.style.background='#2980b9'"
                      onmouseout="this.style.background='#3498db'">
                ‚û§
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

  </div>
  
  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div>
    
    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <div style="width: 50px; height: 50px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
          <span style="color: white; font-size: 18px; font-weight: bold;">
            {% if application and application.job and application.job.employer %}
              {{ application.job.employer.name[0] }}
            {% else %}
              üë§
            {% endif %}
          </span>
        </div>
        <div>
          <div style="font-weight: 600; color: #2c3e50;">
            {% if application and application.job and application.job.employer %}
              {{ application.job.employer.name }}
            {% else %}
              –†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å
            {% endif %}
          </div>
          <div style="color: #6c757d; font-size: 14px;">–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å</div>
          <div style="color: #f39c12;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
      </div>
      
      {% if application and application.job %}
      <div style="border-top: 1px solid #e9ecef; padding-top: 15px;">
        <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">
          <strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {{ application.job.title }}
        </div>
        {% if application.job.location %}
        <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">
          <strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {{ application.job.location }}
        </div>
        {% endif %}
        {% if application.job.salary_min and application.job.salary_max %}
        <div style="font-size: 14px; color: #2980b9; font-weight: 600;">
          üí∞ {{ "{:,}".format(application.job.salary_min) }} - {{ "{:,}".format(application.job.salary_max) }} {{ application.job.salary_currency or '—Ç–µ–Ω–≥–µ' }}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- –ù–û–í–´–ô –ë–õ–û–ö: –°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ -->
    {% if application and application.cover_letter %}
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 20px;">‚úâÔ∏è</span>
        –°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
      </h4>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #3498db;">
        <div style="color: #495057; line-height: 1.6; font-size: 14px; font-style: italic;">
          "{{ application.cover_letter }}"
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef; color: #6c757d; font-size: 12px;">
          <strong>–î–∞—Ç–∞ –æ—Ç–∫–ª–∏–∫–∞:</strong> {{ application.created_at.strftime('%d.%m.%Y –≤ %H:%M') if application.created_at else '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞' }}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- –î–æ—Ö–æ–¥—ã -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50;">–î–æ—Ö–æ–¥—ã</h4>
      
      <div style="background: linear-gradient(135deg, #e8f5e8, #d4edda); border: 2px solid #28a745; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
        <div style="color: #155724; font-weight: 600; font-size: 14px; margin-bottom: 8px;">üí∞ –í–∞—à –¥–æ—Ö–æ–¥:</div>
        <div style="color: #28a745; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
          {{ "{:,}".format(recruiter_earnings) if recruiter_earnings else '0' }} ‚Ç∏
        </div>
        <div style="color: #6c757d; font-size: 12px;">70% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</div>
      </div>
      
      {% if application and application.status and application.status.value in ['selected', 'working', 'completed'] %}
        <div style="background: #28a745; color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; text-align: center; font-weight: 600;">
          ‚úÖ –î–æ—Ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
        </div>
      {% else %}
        <div style="background: #ffc107; color: #856404; padding: 8px 12px; border-radius: 8px; font-size: 14px; text-align: center; font-weight: 600;">
          ‚è≥ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥
        </div>
      {% endif %}
    </div>

    <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50;">–î–æ–∫—É–º–µ–Ω—Ç—ã</h4>
      
      {% if chat_documents %}
        {% for document in chat_documents %}
          <div style="margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="width: 32px; height: 32px; background: #dc3545; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                <span style="color: white; font-size: 12px; font-weight: bold;">
                  {{ document.file_type.upper() if document.file_type else 'DOC' }}
                </span>
              </div>
              <div style="flex: 1;">
                <div style="color: #3498db; font-size: 14px; text-decoration: none; cursor: pointer;">
                  {{ document.original_name if document.original_name else '–î–æ–∫—É–º–µ–Ω—Ç' }}
                </div>
                <div style="color: #6c757d; font-size: 12px;">
                  {{ document.created_at.strftime('%d.%m.%Y') if document.created_at else '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞' }}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div style="text-align: center; padding: 20px; color: #6c757d;">
          <div style="font-size: 32px; margin-bottom: 12px;">üìÑ</div>
          <div style="font-size: 14px;">–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
        </div>
      {% endif %}

      <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê: –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª -->
      <div style="margin-top: 15px; border-top: 1px solid #e9ecef; padding-top: 15px;">
        <button onclick="addDocumentFile()" 
                style="width: 100%; background: #17a2b8; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;"
                onmouseover="this.style.background='#138496'"
                onmouseout="this.style.background='#17a2b8'">
          <span style="font-size: 16px;">üìÅ</span>
          –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª
        </button>
        
        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
        <input type="file" id="document-file-input" style="display: none;" accept=".pdf,.doc,.docx,.txt,.jpg,.png,.jpeg,.xls,.xlsx">
      </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è (–£–ë–†–ê–ù–ê –ö–ù–û–ü–ö–ê "–ù–ê–ó–ê–î –ö –ó–ê–Ø–í–ö–ê–ú") -->
    <div style="display: flex; flex-direction: column; gap: 10px;">
      {% if application and application.job %}
      <a href="/jobs/{{ application.job.id }}" 
         style="background: #3498db; color: white; padding: 12px; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; transition: background 0.3s;"
         onmouseover="this.style.background='#2980b9'"
         onmouseout="this.style.background='#3498db'">
        üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é
      </a>
      {% endif %}
      
      {% if application and application.status and application.status.value == 'completed' %}
        <a href="/rate_employer/{{ application.job.employer.id }}" 
           style="background: #f39c12; color: white; padding: 12px; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; transition: background 0.3s;"
           onmouseover="this.style.background='#e67e22'"
           onmouseout="this.style.background='#f39c12'">
          ‚≠ê –û—Ü–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è
        </a>
      {% endif %}
    </div>

  </div>
  
</div>

<!-- JavaScript –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —á–∞—Ç–∞ -->
<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–æ–º
let lastMessageId = null;
let isRefreshing = false;

function autoResize(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

function handleKeyPress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage(event);
  }
}

function sendMessage(event) {
  event.preventDefault();
  const input = document.getElementById('message-input');
  const message_content = input.value.trim();
  
  if (message_content) {
    const application_id = '{{ application.id if application else "" }}';
    if (application_id) {
      // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
      const sendButton = event.target.querySelector('button[type="submit"]');
      if (sendButton) sendButton.disabled = true;
      
      fetch('/api/send_message', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          application_id: application_id,
          content: message_content,
          message_type: 'text'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          addMessageToChat(message_content, true);
          input.value = '';
          input.style.height = 'auto';
          lastMessageId = data.message_id;
        } else {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', data.error);
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
      })
      .finally(() => {
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
        if (sendButton) sendButton.disabled = false;
      });
    } else {
      alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –∑–∞—è–≤–∫–∏');
    }
  }
}

function addMessageToChat(message_text, is_from_current_user) {
  const chatMessages = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  const current_time = new Date();
  const time_string = current_time.getHours().toString().padStart(2, '0') + ':' + 
                     current_time.getMinutes().toString().padStart(2, '0');
  
  messageDiv.innerHTML = `
    <div style="display: flex; justify-content: ${is_from_current_user ? 'flex-end' : 'flex-start'}; margin-bottom: 15px;">
      <div style="max-width: 70%; 
                  background: ${is_from_current_user ? '#3498db' : 'white'}; 
                  color: ${is_from_current_user ? 'white' : '#2c3e50'}; 
                  padding: 12px 16px; 
                  border-radius: 18px; 
                  ${is_from_current_user ? '' : 'border: 1px solid #e9ecef;'} 
                  box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
        <div style="font-size: 14px; line-height: 1.4;">
          ${message_text}
        </div>
        <div style="font-size: 12px; 
                   color: ${is_from_current_user ? 'rgba(255,255,255,0.8)' : '#6c757d'}; 
                   margin-top: 8px;">
          ${time_string}
        </div>
      </div>
    </div>
  `;
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function attachFile() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.pdf,.doc,.docx,.txt,.jpg,.png,.jpeg';
  fileInput.onchange = function(event) {
    const selected_file = event.target.files[0];
    if (selected_file) {
      uploadChatFile(selected_file);
    }
  };
  fileInput.click();
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Ä–∞–∑–¥–µ–ª –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
function addDocumentFile() {
  const fileInput = document.getElementById('document-file-input');
  fileInput.onchange = function(event) {
    const selected_file = event.target.files[0];
    if (selected_file) {
      uploadDocumentFile(selected_file);
    }
  };
  fileInput.click();
}

// –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
function uploadDocumentFile(file_to_upload) {
  const application_id = '{{ application.id if application else "" }}';
  if (!application_id) {
    alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –∑–∞—è–≤–∫–∏');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file_to_upload);
  formData.append('application_id', application_id);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<span style="font-size: 16px;">‚è≥</span> –ó–∞–≥—Ä—É–∑–∫–∞...';
  button.disabled = true;
  
  fetch('/api/upload_chat_file', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
      window.location.reload();
    } else {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
  })
  .finally(() => {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
    button.innerHTML = originalText;
    button.disabled = false;
  });
}

function uploadChatFile(file_to_upload) {
  const application_id = '{{ application.id if application else "" }}';
  if (!application_id) {
    alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –∑–∞—è–≤–∫–∏');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file_to_upload);
  formData.append('application_id', application_id);
  
  fetch('/api/upload_chat_file', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      addMessageToChat(`üìé –§–∞–π–ª: ${file_to_upload.name}`, true);
    } else {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
  });
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
function refreshChatMessages() {
  if (isRefreshing) return;
  
  const application_id = '{{ application.id if application else "" }}';
  if (application_id) {
    isRefreshing = true;
    
    fetch(`/api/get_messages/${application_id}`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.messages) {
          updateChatDisplay(data.messages);
        }
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
      })
      .finally(() => {
        isRefreshing = false;
      });
  }
}

function updateChatDisplay(new_messages) {
  const chatMessages = document.getElementById('chat-messages');
  const current_user_id = '{{ current_user.id if current_user else "" }}';
  
  // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  if (new_messages.length > 0) {
    chatMessages.innerHTML = '';
    
    new_messages.forEach(msg => {
      const messageDiv = document.createElement('div');
      const is_current_user = msg.sender_id === current_user_id;
      const message_time = new Date(msg.created_at).toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      messageDiv.innerHTML = `
        <div style="display: flex; justify-content: ${is_current_user ? 'flex-end' : 'flex-start'}; margin-bottom: 15px;">
          <div style="max-width: 70%; 
                      background: ${is_current_user ? '#3498db' : 'white'}; 
                      color: ${is_current_user ? 'white' : '#2c3e50'}; 
                      padding: 12px 16px; 
                      border-radius: 18px; 
                      ${is_current_user ? '' : 'border: 1px solid #e9ecef;'} 
                      box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
            <div style="font-size: 14px; line-height: 1.4;">
              ${msg.content}
            </div>
            <div style="font-size: 12px; 
                       color: ${is_current_user ? 'rgba(255,255,255,0.8)' : '#6c757d'}; 
                       margin-top: 8px;">
              ${message_time}
            </div>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
    });
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
}

// –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
setInterval(refreshChatMessages, 5000);

// –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å —á–∞—Ç –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  const chatMessages = document.getElementById('chat-messages');
  if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
});
</script>

<style>
@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-6px); opacity: 1; }
}
</style>

</div>

{% endblock %}
