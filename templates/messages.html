{% extends "base.html" %}
{% block content %}

<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏) -->
<div style="margin-bottom: 20px; text-align: left;">
  <nav style="font-size: 14px; color: #6c757d;">
    <a href="/" style="color: #3498db; text-decoration: none;">–ì–ª–∞–≤–Ω–∞—è</a>
    <span style="margin: 0 8px;">/</span>
    {% if application %}
      {% if current_user.user_type.value == 'recruiter' %}
        <a href="/my/applications" style="color: #3498db; text-decoration: none;">–ú–æ–∏ –∑–∞—è–≤–∫–∏</a>
      {% elif current_user.user_type.value == 'employer' %}
        <a href="/my/jobs" style="color: #3498db; text-decoration: none;">–ú–æ–∏ –≤–∞–∫–∞–Ω—Å–∏–∏</a>
      {% endif %}
      <span style="margin: 0 8px;">/</span>
      <span>{{ application.job.title }}</span>
    {% else %}
      <span>–°–æ–æ–±—â–µ–Ω–∏—è</span>
    {% endif %}
  </nav>
</div>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div style="margin-bottom: 30px; text-align: left;">
  {% if application %}
    <h1 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0 0 8px 0;">
      –ß–∞—Ç –ø–æ –≤–∞–∫–∞–Ω—Å–∏–∏: {{ application.job.title }}
    </h1>
    <div style="color: #6c757d; font-size: 14px;">
      –ó–∞—è–≤–∫–∞ ‚Ññ{{ application.id[:6] }}
    </div>
  {% else %}
    <h1 style="font-size: 28px; font-weight: 700; color: #2c3e50; margin: 0 0 8px 0;">
      –°–æ–æ–±—â–µ–Ω–∏—è
    </h1>
    <div style="color: #6c757d; font-size: 14px;">
      –í–∞—à–∏ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    </div>
  {% endif %}
</div>

  
  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ß–∞—Ç —Å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–º -->
  <div>
    
    <!-- –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 18px; color: #2c3e50;">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</h3>
        
        {% if application %}
    {% if application is not none and application.status.value == 'pending' %}

        <!-- –∫–æ–¥ –¥–ª—è pending —Å—Ç–∞—Ç—É—Å–∞ -->
    {% elif application.status.value == 'approved' %}
        <!-- –∫–æ–¥ –¥–ª—è approved —Å—Ç–∞—Ç—É—Å–∞ -->
    {% else %}
        <!-- –∫–æ–¥ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ -->
    {% endif %}
{% else %}
    <!-- –∫–æ–¥ –∫–æ–≥–¥–∞ –Ω–µ—Ç –∑–∞—è–≤–ª–µ–Ω–∏—è -->
    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–ª–µ–Ω–∏–π</p>
{% endif %}

      </div>
      
      <!-- –î–µ—Ç–∞–ª–∏ —Å—Ç–∞—Ç—É—Å–∞ -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
        <div>
          <div style="color: #6c757d; margin-bottom: 5px;">–§–ò–û –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</div>
          <div style="color: #2c3e50; font-weight: 500;">
            {% if application.status.value in ['selected', 'working', 'completed'] %}
              {{ current_user.name }}
            {% else %}
              –û–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
            {% endif %}
          </div>
        </div>
        <div>
          <div style="color: #6c757d; margin-bottom: 5px;">–û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞</div>
          <div style="color: #2c3e50; font-weight: 500;">
            {% if application.expected_start_date %}
              {{ application.expected_start_date.strftime('%d.%m.%Y') }}
            {% else %}
              –ù–µ —É–∫–∞–∑–∞–Ω–∞
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∫—Ä—É—Ç–µ—Ä—ã -->
      <div style="margin-top: 20px;">
        <div style="color: #6c757d; margin-bottom: 10px; font-size: 14px;">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–µ–∫—Ä—É—Ç–µ—Ä—ã</div>
        {% if selected_recruiters %}
          {% for recruiter in selected_recruiters %}
            <div style="display: inline-block; background: #3498db; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin-right: 8px; margin-bottom: 8px;">
              {{ recruiter.name }}
            </div>
          {% endfor %}
        {% else %}
          <div style="color: #6c757d; font-style: italic;">–†–µ–∫—Ä—É—Ç–µ—Ä—ã –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
        {% endif %}
      </div>
    </div>

    <!-- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —á–∞—Ç–∞ —Å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª–µ–º -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; overflow: hidden; height: 600px; display: flex; flex-direction: column;">
      
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
      <div style="background: #f8f9fa; padding: 20px; border-bottom: 1px solid #e9ecef;">
        <div style="display: flex; align-items: center; justify-content: between;">
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="width: 45px; height: 45px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <span style="color: white; font-size: 16px; font-weight: bold;">
                {{ application.job.employer.name[0] }}
              </span>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 18px; color: #2c3e50;">{{ application.job.employer.name }}</h3>
              <div style="color: #28a745; font-size: 14px;">‚óè –û–Ω–ª–∞–π–Ω</div>
            </div>
          </div>
          <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ª–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–æ–±—â–µ–Ω–∏–π -->
          <a href="/messages/to/{{ application.job.employer.id }}" 
             style="background: #3498db; color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 14px; font-weight: 500;">
            –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
          </a>
        </div>
      </div>
      
      <!-- –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —á–∞—Ç–∞ -->
      <div style="flex: 1; display: flex; flex-direction: column;">
        <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º iframe –∏–ª–∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —á–∞—Ç–∞ -->
        <!-- –í–∞—Ä–∏–∞–Ω—Ç 1: –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —á–∞—Ç–∞ -->
        <iframe 
          src="/messages/embedded/{{ application.job.employer.id }}?compact=true" 
          style="width: 100%; height: 100%; border: none; background: #fafafa;"
          id="chat-frame">
        </iframe>
        
        <!-- –í–∞—Ä–∏–∞–Ω—Ç 2: –ï—Å–ª–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —á–∞—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é -->
        <!--
        {% if messages_component %}
          {% include 'components/chat_window.html' with context %}
        {% endif %}
        -->
        
        <!-- –í–∞—Ä–∏–∞–Ω—Ç 3: –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ —á–µ—Ä–µ–∑ AJAX -->
        <div id="chat-container" style="flex: 1; padding: 0;">
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d;">
            <div>
              <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: #f8f9fa; border-radius: 50%; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center;">
                  üí¨
                </div>
                <div style="font-size: 16px; margin-bottom: 10px;">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
                <div style="font-size: 14px;">–ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç" –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞</div>
              </div>
              <div style="text-align: center;">
                <a href="/messages/to/{{ application.job.employer.id }}" 
                   style="background: #3498db; color: white; padding: 12px 24px; border-radius: 24px; text-decoration: none; font-weight: 500;">
                  üí¨ –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  
  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div>
    
    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <div style="width: 50px; height: 50px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
          <span style="color: white; font-size: 18px; font-weight: bold;">
            {{ application.job.employer.name[0] }}
          </span>
        </div>
        <div>
          <div style="font-weight: 600; color: #2c3e50;">{{ application.job.employer.name }}</div>
          <div style="color: #6c757d; font-size: 14px;">–†–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å</div>
          <div style="color: #f39c12;">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
      </div>
      
      <div style="border-top: 1px solid #e9ecef; padding-top: 15px;">
        <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">
          <strong>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</strong> {{ application.job.title }}
        </div>
        {% if application.job.location %}
        <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">
          <strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {{ application.job.location }}
        </div>
        {% endif %}
        {% if application.job.employment_type %}
        <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">
          <strong>–¢–∏–ø –∑–∞–Ω—è—Ç–æ—Å—Ç–∏:</strong> {{ application.job.employment_type }}
        </div>
        {% endif %}
        {% if application.job.salary_min and application.job.salary_max %}
        <div style="font-size: 14px; color: #2980b9; font-weight: 600;">
          üí∞ {{ "{:,}".format(application.job.salary_min) }} - {{ "{:,}".format(application.job.salary_max) }} {{ application.job.salary_currency or '—Ç–µ–Ω–≥–µ' }}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- –í–∞—à–µ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ -->
    {% if application.cover_letter %}
      <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ</h4>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6; color: #2c3e50; font-size: 14px;">
          {{ application.cover_letter }}
        </div>
      </div>
    {% endif %}

    <!-- –î–æ—Ö–æ–¥—ã -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50;">–î–æ—Ö–æ–¥—ã</h4>
      
      <div style="background: linear-gradient(135deg, #e8f5e8, #d4edda); border: 2px solid #28a745; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
        <div style="color: #155724; font-weight: 600; font-size: 14px; margin-bottom: 8px;">üí∞ –í–∞—à –¥–æ—Ö–æ–¥:</div>
        <div style="color: #28a745; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
          {{ "{:,}".format(recruiter_earnings) }} ‚Ç∏
        </div>
        <div style="color: #6c757d; font-size: 12px;">70% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</div>
      </div>
      
      {% if application.status.value in ['selected', 'working', 'completed'] %}
        <div style="background: #28a745; color: white; padding: 8px 12px; border-radius: 8px; font-size: 14px; text-align: center; font-weight: 600;">
          ‚úÖ –î–æ—Ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
        </div>
      {% else %}
        <div style="background: #ffc107; color: #856404; padding: 8px 12px; border-radius: 8px; font-size: 14px; text-align: center; font-weight: 600;">
          ‚è≥ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥
        </div>
      {% endif %}
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–∫–∏ -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–∫–∏</h4>
      
      <div style="position: relative;">
        <!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ -->
        <div style="position: absolute; left: 12px; top: 20px; bottom: 0; width: 2px; background: #e9ecef;"></div>
        
        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ -->
        <div style="display: flex; align-items: flex-start; margin-bottom: 15px; position: relative;">
          <div style="width: 24px; height: 24px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; position: relative; z-index: 1;">
            <span style="color: white; font-size: 10px; font-weight: bold;">1</span>
          </div>
          <div>
            <div style="font-weight: 600; color: #2c3e50; font-size: 14px;">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
            <div style="color: #6c757d; font-size: 12px;">{{ application.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
          </div>
        </div>
        
        {% if application.status.value != 'pending' %}
        <!-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
        <div style="display: flex; align-items: flex-start; margin-bottom: 15px; position: relative;">
          <div style="width: 24px; height: 24px; background: #27ae60; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; position: relative; z-index: 1;">
            <span style="color: white; font-size: 10px; font-weight: bold;">2</span>
          </div>
          <div>
            <div style="font-weight: 600; color: #2c3e50; font-size: 14px;">
              {% if application.status.value == 'selected' %}
                –í—ã–±—Ä–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã
              {% elif application.status.value == 'working' %}
                –ù–∞—á–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞
              {% elif application.status.value == 'completed' %}
                –†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
              {% elif application.status.value == 'rejected' %}
                –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞
              {% endif %}
            </div>
            <div style="color: #6c757d; font-size: 12px;">
              {% if application.updated_at %}
                {{ application.updated_at.strftime('%d.%m.%Y %H:%M') }}
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; margin-bottom: 20px;">
      <h4 style="margin: 0 0 15px 0; color: #2c3e50;">–î–æ–∫—É–º–µ–Ω—Ç—ã</h4>
      
      <!-- –ü—Ä–∏–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
      <div style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="width: 32px; height: 32px; background: #dc3545; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
            <span style="color: white; font-size: 12px; font-weight: bold;">PDF</span>
          </div>
          <div style="flex: 1;">
            <div style="color: #3498db; font-size: 14px; text-decoration: none; cursor: pointer;">
              –î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥
            </div>
            <div style="color: #6c757d; font-size: 12px;">15.07.2021</div>
          </div>
        </div>
      </div>
      
      <!-- –§–∞–π–ª—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ -->
      <div style="margin-bottom: 12px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="width: 32px; height: 32px; background: #2196f3; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
            <span style="color: white; font-size: 10px; font-weight: bold;">DOC</span>
          </div>
          <div style="flex: 1;">
            <div style="color: #3498db; font-size: 14px; text-decoration: none; cursor: pointer;">
              –†–µ–∑—é–º–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞.docx
            </div>
            <div style="color: #6c757d; font-size: 12px;">110.5 –ö–ë ‚Ä¢ 01.03.2025</div>
          </div>
        </div>
      </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div style="display: flex; flex-direction: column; gap: 10px;">
      <a href="/jobs/{{ application.job.id }}" 
         style="background: #3498db; color: white; padding: 12px; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; transition: background 0.3s;"
         onmouseover="this.style.background='#2980b9'"
         onmouseout="this.style.background='#3498db'">
        üìÑ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é
      </a>
      
      <a href="/my/applications" 
         style="background: #6c757d; color: white; padding: 12px; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; transition: background 0.3s;"
         onmouseover="this.style.background='#5a6268'"
         onmouseout="this.style.background='#6c757d'">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞—è–≤–∫–∞–º
      </a>
      
      {% if application.status.value == 'completed' %}
        <a href="/rate_employer/{{ application.job.employer.id }}" 
           style="background: #f39c12; color: white; padding: 12px; text-align: center; border-radius: 8px; text-decoration: none; font-weight: 600; transition: background 0.3s;"
           onmouseover="this.style.background='#e67e22'"
           onmouseout="this.style.background='#f39c12'">
          ‚≠ê –û—Ü–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è
        </a>
      {% endif %}
    </div>

  </div>
  
</div>

<!-- JavaScript –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π —á–∞—Ç–∞ -->
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞ —á–µ—Ä–µ–∑ AJAX (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç 3)
function loadChatMessages() {
  fetch(`/api/messages/{{ application.job.employer.id }}?preview=true`)
    .then(response => response.json())
    .then(data => {
      if (data.messages && data.messages.length > 0) {
        const container = document.getElementById('chat-container');
        container.innerHTML = renderChatPreview(data.messages);
      }
    })
    .catch(error => {
      console.log('Chat preview not available:', error);
    });
}

function renderChatPreview(messages) {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
  const recentMessages = messages.slice(-3);
  let html = '<div style="padding: 20px; flex: 1; overflow-y: auto; background: #fafafa;">';
  
  recentMessages.forEach(message => {
    const isUser = message.sender_id === '{{ current_user.id }}';
    const time = new Date(message.created_at).toLocaleTimeString('ru-RU', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    html += `
      <div style="display: flex; justify-content: ${isUser ? 'flex-end' : 'flex-start'}; margin-bottom: 15px;">
        <div style="max-width: 70%; background: ${isUser ? '#3498db' : 'white'}; color: ${isUser ? 'white' : '#2c3e50'}; padding: 12px 16px; border-radius: 18px; ${isUser ? '' : 'border: 1px solid #e9ecef;'} box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
          <div style="font-size: 14px; line-height: 1.4;">
            ${message.content}
          </div>
          <div style="font-size: 12px; color: ${isUser ? 'rgba(255,255,255,0.8)' : '#6c757d'}; margin-top: 8px;">${time}</div>
        </div>
      </div>
    `;
  });
  
  html += `
    </div>
    <div style="padding: 15px; border-top: 1px solid #e9ecef; background: white; text-align: center;">
      <a href="/messages/to/{{ application.job.employer.id }}" 
         style="background: #3498db; color: white; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-size: 14px;">
        –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π —á–∞—Ç
      </a>
    </div>
  `;
  
  return html;
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–≤—å—é —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AJAX –≤–∞—Ä–∏–∞–Ω—Ç)
document.addEventListener('DOMContentLoaded', function() {
  // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AJAX –∑–∞–≥—Ä—É–∑–∫—É
  // loadChatMessages();
  
  // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è iframe, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
  const chatFrame = document.getElementById('chat-frame');
  if (chatFrame) {
    chatFrame.onload = function() {
      // Iframe –∑–∞–≥—Ä—É–∂–µ–Ω
      console.log('Chat iframe loaded');
    };
  }
});
</script>

</div>

{% endblock %}
